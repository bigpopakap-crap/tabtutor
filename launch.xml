<project default="start">
	<property name="launch.propfile" value="launch.properties"/>		<!-- Name of env var file -->
	<property name="launch.startproc" value="Procfile.dev"/>			<!-- Name of app Procfile -->
	<property name="launch.testproc" value="Procfile.test"/>			<!-- Name of test Procfile -->
	<property name="launch.pidfile" value="RUNNING_PID"/>				<!-- Name of the file with the PID -->

	<!-- Start the app -->
	<target name="start" depends="stop">
		<antcall target="-foreman">
			<param name="foreman-procfile" value="${launch.startproc}"/>
		</antcall>
	</target>
	
	<!-- Run tests -->
	<target name="test" depends="stop">
		<antcall target="-foreman">
			<param name="foreman-procfile" value="${launch.testproc}"/>
		</antcall>
	</target>
	
	<!-- Stop the app -->
	<target name="stop">
		<!-- TODO run only if the PID file exists -->
		<!-- Get the PID to kill -->
		<loadfile property="pid" srcFile="${launch.pidfile}" failonerror="false"/>
	
		<!-- Kill the process -->
		<antcall target="-kill">
			<param name="kill-pid" value="${pid}"/>
		</antcall>
		
		<!-- Remove the PID file -->
		<antcall target="-rm">
			<param name="rm-path" value="${launch.pidfile}"/>
		</antcall>
	</target>
	
	<!-- ********************************************************************************
		BEGIN HELPER TARGETS
	********************************************************************************* -->
	
	<!--
		Run foreman on the given Procfile
		params:
			foreman-procfile - the Procfile to use
	-->
	<target name="-foreman">
		<antcall target="-exec">
			<param name="exec-basedir" value="${basedir}"/>
			<param name="exec-line" value="foreman start -f ${foreman-procfile} -e ${launch.propfile}"/>
		</antcall>
	</target>
	
	<!-- ********************************************************************************
		BEGIN OS-SPECIFIC BASE-LEVEL COMMANDS
	********************************************************************************* -->
	
	<!-- 
		Kill the given process (detects current OS)
		params:
			kill-pid - the PID of the process to kill
	-->
	<target name="-kill">
		<!-- Windows -->
		<antcall target="-exec">
			<param name="exec-basedir" value="${basedir}"/>
			<param name="exec-line" value="taskkill /f /pid ${kill-pid}"/>
		</antcall>
	</target>
	
	<!-- 
		Removes the given file (detects current OS)
		params:
			rm-path - the path of the file to remove
	-->
	<target name="-rm">
		<!-- Windows -->
		<antcall target="-exec">
			<param name="exec-basedir" value="${basedir}"/>
			<param name="exec-line" value="del ${rm-path}"/>
		</antcall>
	</target>
	
	<!--
		Execute commands (detects current OS)
		params:
			exec-basedir - the dir to execute in
			exec-line 	 - the command to execute
	-->
	<target name="-exec">
		<!-- Windows -->
		<exec dir="${exec-basedir}" executable="cmd">
			<arg line="/c ${exec-line}"/>
		</exec>
	</target>
</project>